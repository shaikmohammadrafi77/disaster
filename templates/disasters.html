<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disasters - Disaster Relief</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/disaster-style.css') }}">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">
                <i data-feather="shield" class="me-2"></i>
                Disaster Relief Command Center
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard') }}">
                            <i data-feather="home" class="me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('disasters') }}">
                            <i data-feather="alert-triangle" class="me-1"></i>Disasters
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('resources') }}">
                            <i data-feather="package" class="me-1"></i>Resources
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('allocations') }}">
                            <i data-feather="truck" class="me-1"></i>Allocations
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('centers') }}">
                            <i data-feather="map-pin" class="me-1"></i>Centers
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('map_view') }}">
                            <i data-feather="map" class="me-1"></i>Map
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2>
                            <i data-feather="alert-triangle" class="me-2 text-danger"></i>
                            Disaster Management
                        </h2>
                        <p class="text-muted mb-0">Monitor and manage active disasters</p>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="showCreateDisasterModal()">
                            <i data-feather="plus" class="me-2"></i>
                            Report New Disaster
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <label for="statusFilter" class="form-label">Status</label>
                                <select class="form-select" id="statusFilter" onchange="loadDisasters()">
                                    <option value="all">All Statuses</option>
                                    <option value="active">Active</option>
                                    <option value="contained">Contained</option>
                                    <option value="resolved">Resolved</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="typeFilter" class="form-label">Type</label>
                                <select class="form-select" id="typeFilter" onchange="loadDisasters()">
                                    <option value="all">All Types</option>
                                    <option value="earthquake">Earthquake</option>
                                    <option value="flood">Flood</option>
                                    <option value="hurricane">Hurricane</option>
                                    <option value="wildfire">Wildfire</option>
                                    <option value="tornado">Tornado</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="severityFilter" class="form-label">Severity</label>
                                <select class="form-select" id="severityFilter" onchange="loadDisasters()">
                                    <option value="all">All Severities</option>
                                    <option value="5">Level 5 (Critical)</option>
                                    <option value="4">Level 4 (High)</option>
                                    <option value="3">Level 3 (Moderate)</option>
                                    <option value="2">Level 2 (Low)</option>
                                    <option value="1">Level 1 (Minimal)</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button class="btn btn-outline-primary w-100" onclick="loadDisasters()">
                                    <i data-feather="refresh-cw" class="me-2"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Disasters List -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i data-feather="list" class="me-2"></i>
                            Disasters List
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="disastersContainer">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Initialize Feather Icons
        feather.replace();
        
        // Load disasters on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDisasters();
        });

        // Load disasters from API
        async function loadDisasters() {
            try {
                const statusFilter = document.getElementById('statusFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;
                const severityFilter = document.getElementById('severityFilter').value;
                
                let url = '/api/disasters?';
                if (statusFilter !== 'all') url += `status=${statusFilter}&`;
                if (typeFilter !== 'all') url += `type=${typeFilter}&`;
                if (severityFilter !== 'all') url += `severity=${severityFilter}&`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch disasters');
                
                const disasters = await response.json();
                displayDisasters(disasters);
                
            } catch (error) {
                console.error('Error loading disasters:', error);
                document.getElementById('disastersContainer').innerHTML = `
                    <div class="alert alert-danger">
                        <i data-feather="alert-circle" class="me-2"></i>
                        Failed to load disasters
                    </div>
                `;
                feather.replace();
            }
        }

        // Display disasters
        function displayDisasters(disasters) {
            const container = document.getElementById('disastersContainer');
            
            if (!disasters || disasters.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i data-feather="info" class="mb-3" style="width: 48px; height: 48px;"></i>
                        <h5>No disasters found</h5>
                        <p>No disasters match your current filters</p>
                    </div>
                `;
                feather.replace();
                return;
            }
            
            const html = disasters.map(disaster => `
                <div class="disaster-item severity-${disaster.severity} mb-3" onclick="viewDisaster(${disaster.id})">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center mb-2">
                                <h5 class="mb-0 me-3">${disaster.name}</h5>
                                <span class="disaster-severity me-2">Level ${disaster.severity}</span>
                                <span class="badge bg-${getStatusBadgeClass(disaster.status)}">${disaster.status.charAt(0).toUpperCase() + disaster.status.slice(1)}</span>
                            </div>
                            <div class="row text-muted">
                                <div class="col-md-6">
                                    <small>
                                        <i data-feather="map-pin" class="me-1" style="width: 14px; height: 14px;"></i>
                                        ${disaster.disaster_type.charAt(0).toUpperCase() + disaster.disaster_type.slice(1)}
                                    </small>
                                </div>
                                <div class="col-md-6">
                                    <small>
                                        <i data-feather="users" class="me-1" style="width: 14px; height: 14px;"></i>
                                        ${formatNumber(disaster.affected_population)} affected
                                    </small>
                                </div>
                            </div>
                            <div class="row text-muted mt-1">
                                <div class="col-md-6">
                                    <small>
                                        <i data-feather="clock" class="me-1" style="width: 14px; height: 14px;"></i>
                                        ${formatDate(disaster.created_at)}
                                    </small>
                                </div>
                                <div class="col-md-6">
                                    <small>
                                        <i data-feather="package" class="me-1" style="width: 14px; height: 14px;"></i>
                                        ${disaster.resource_allocations_count} allocations
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); allocateResources(${disaster.id})">
                                    <i data-feather="send" class="me-1"></i>
                                    Allocate
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="event.stopPropagation(); viewOnMap(${disaster.latitude}, ${disaster.longitude})">
                                    <i data-feather="map" class="me-1"></i>
                                    Map
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="event.stopPropagation(); predictNeeds(${disaster.id})">
                                    <i data-feather="trending-up" class="me-1"></i>
                                    Predict
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
            feather.replace();
        }

        // Helper functions
        function getStatusBadgeClass(status) {
            const classes = {
                'active': 'danger',
                'contained': 'warning',
                'resolved': 'success'
            };
            return classes[status] || 'secondary';
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        // Navigation functions
        function viewDisaster(id) {
            // In a real app, this would show detailed disaster view
            console.log('View disaster:', id);
        }

        function allocateResources(id) {
            window.location.href = `/allocations?disaster_id=${id}`;
        }

        function viewOnMap(lat, lng) {
            window.location.href = `/map?center=${lat},${lng}&zoom=10`;
        }

        function predictNeeds(id) {
            // This would trigger the prediction modal with the disaster pre-selected
            window.location.href = `/dashboard?predict=${id}`;
        }

        function showCreateDisasterModal() {
            // In a real app, this would show a modal to create new disaster
            alert('Create disaster functionality would be implemented here');
        }
    </script>
</body>
</html>